---
version: 1.0.0
status: Draft
created: 2025-12-20
last_updated: 2025-12-20
authored_by:
  - Ronald Roy <gsdwig@gmail.com>
---

# Corvran Plugin Specification

**Reverse-Engineered**: true
**Source Module**: corvran

## Executive Summary

The Corvran plugin is a Claude Code plugin that provides interactive tabletop RPG gameplay capabilities by enabling Claude Code to launch and manage the Adventure Engine application. It serves as a bridge between Claude Code's conversational interface and the Adventure Engine web application, allowing users to start adventure sessions, manage game mechanics through skills, and interact with RPG content through natural language commands.

The plugin implements four core skills that handle application lifecycle management (launching/stopping the server), game mechanics (dice rolling), world initialization (character and world setup), and atmospheric enhancement (panel pattern guidance). Together, these skills enable Claude Code to function as both a technical orchestrator and an interactive game master for tabletop RPG experiences.

## User Story

As a tabletop RPG player using Claude Code, I want to launch and interact with adventure sessions through natural language commands, so that I can experience immersive narrative gameplay with persistent character and world state without managing server processes or application configuration manually.

## Stakeholders

- **Primary**: RPG players using Claude Code to run tabletop-style adventures
- **Secondary**: Adventure Engine developers, game masters creating custom adventures, plugin developers extending RPG capabilities
- **Tertiary**: Server administrators deploying Adventure Engine, content creators building adventures, Claude Code plugin ecosystem maintainers

## Success Criteria

1. Users can launch the Adventure Engine application from any adventure project directory with a single command
2. Server launches successfully within 30 seconds and opens browser to gameplay interface
3. Dice rolling produces deterministic JSON output compatible with RPG system rules
4. Character and world initialization creates properly structured markdown files following documented templates
5. Panel pattern guidance provides contextually relevant suggestions for atmospheric UI enhancement

## Functional Requirements

### Application Lifecycle Management

- **REQ-F-1**: System must launch the Adventure Engine web application from the current working directory when user requests to "enter" a world or "start" an adventure
- **REQ-F-2**: System must validate that the current directory is a valid adventure project before launching
- **REQ-F-3**: System must build the frontend application before starting the backend server
- **REQ-F-4**: System must start the backend server in fire-and-forget mode, allowing the server to run independently after launch
- **REQ-F-5**: System must perform health checks on the backend server for up to 30 seconds before considering launch successful
- **REQ-F-6**: System must open a web browser to the server URL after successful health check
- **REQ-F-7**: System must support headless operation with `--no-browser` option for remote/headless environments
- **REQ-F-8**: System must log all server output to `.adventure-engine.log` in the project directory
- **REQ-F-9**: System must write server process ID to `.adventure-engine.pid` for lifecycle management
- **REQ-F-10**: System must provide graceful shutdown capability through stop script
- **REQ-F-11**: System must validate PID is a bun/node process before terminating to prevent accidental process kills
- **REQ-F-12**: System must attempt graceful shutdown for 5 seconds before force-killing server process

### Environment Configuration

- **REQ-F-13**: System must support environment variable overrides through `.env` files in multiple locations (engine root, backend, project directory)
- **REQ-F-14**: System must apply environment variable precedence: project directory overrides engine defaults
- **REQ-F-15**: System must determine Adventure Engine installation directory from script location or `CORVRAN_DIR` environment variable
- **REQ-F-16**: System must convert all directory paths to absolute paths before passing to server
- **REQ-F-17**: System must support configurable server host, port, and static file locations through environment variables

### Dice Rolling Mechanics

- **REQ-F-18**: System must parse standard tabletop RPG dice notation (NdX, NdX+M, NdX-M formats)
- **REQ-F-19**: System must support common die types: d4, d6, d8, d10, d12, d20, d100
- **REQ-F-20**: System must support Fudge dice (dF) with values -1, 0, +1
- **REQ-F-21**: System must generate random rolls using system randomness (RANDOM in bash)
- **REQ-F-22**: System must output dice roll results as JSON with expression, individual rolls, modifier, and total
- **REQ-F-23**: System must validate dice expressions and return error JSON for invalid input
- **REQ-F-24**: System must apply modifiers to roll totals after summing individual dice

### Character and World Initialization

- **REQ-F-25**: System must provide guidance for character creation when playerRef is null
- **REQ-F-26**: System must provide guidance for world creation when worldRef is null
- **REQ-F-27**: System must list available characters from the `players/` directory
- **REQ-F-28**: System must list available worlds from the `worlds/` directory
- **REQ-F-29**: System must guide users through selecting existing or creating new characters/worlds
- **REQ-F-30**: System must document character sheet structure with attributes, combat stats, skills, equipment, and abilities
- **REQ-F-31**: System must document character state structure with location, condition, resources, objectives, and recent events
- **REQ-F-32**: System must document world state structure with genre, era, tone, factions, NPCs, and established facts
- **REQ-F-33**: System must document locations structure with type, region, description, features, and connections
- **REQ-F-34**: System must document NPC structure with role, location, disposition, description, and notes
- **REQ-F-35**: System must document quest structure with active and completed quest tracking, progress checklists, and rewards

### Panel Pattern Library

- **REQ-F-36**: System must provide panel pattern suggestions organized by context (universal, location-based, genre-specific, game state)
- **REQ-F-37**: System must provide universal panel patterns for weather, status alerts, timers, and resource tracking
- **REQ-F-38**: System must provide location-based patterns for taverns, wilderness travel, dungeons, and urban environments
- **REQ-F-39**: System must provide genre-specific patterns for high fantasy, cyberpunk, space opera, horror, and survival scenarios
- **REQ-F-40**: System must provide game state patterns for combat, faction standing, and exploration discovery logs
- **REQ-F-41**: System must document panel creation guidelines including when to create, update, and dismiss panels
- **REQ-F-42**: System must document panel position selection (sidebar for persistent status, header for urgent alerts, overlay for special emphasis)
- **REQ-F-43**: System must provide content structure templates for each panel pattern including format, triggers, and examples

## Non-Functional Requirements

### Performance

- **REQ-NF-1** (Startup Time): Server health check must timeout after 30 seconds if server fails to respond
- **REQ-NF-2** (Shutdown Time): Graceful shutdown must complete within 5 seconds before force-kill
- **REQ-NF-3** (Responsiveness): Dice roller script must execute and return results within 1 second

### Reliability

- **REQ-NF-4** (PID Safety): System must verify PID corresponds to bun/node process before killing to prevent accidental termination of unrelated processes
- **REQ-NF-5** (Cleanup): System must remove PID file on successful shutdown or when detecting stale PID
- **REQ-NF-6** (Error Handling): System must validate all directory paths exist before attempting operations
- **REQ-NF-7** (Idempotency): Stop script must handle already-stopped servers gracefully without error

### Usability

- **REQ-NF-8** (Logging): All server lifecycle events must be logged with ISO 8601 timestamps to `.adventure-engine.log`
- **REQ-NF-9** (Error Messages): Invalid dice expressions must return JSON error messages with usage guidance
- **REQ-NF-10** (Documentation): Each skill must include clear usage examples and trigger descriptions
- **REQ-NF-11** (Cross-Platform): Browser opening must support Linux (xdg-open) and macOS (open) platforms

### Maintainability

- **REQ-NF-12** (File Organization): Skills must be organized in dedicated directories with descriptive names
- **REQ-NF-13** (Template Consistency): All markdown templates must follow consistent structure with clear section headers
- **REQ-NF-14** (Script Modularity): Launch and stop scripts must be independent and reusable outside plugin context
- **REQ-NF-15** (Configuration Flexibility): All hardcoded paths must be overridable via environment variables

## Explicit Constraints (DO NOT)

- Do NOT allow server launch without validating project directory structure
- Do NOT kill processes by PID without verifying they are bun/node processes
- Do NOT skip frontend build step before launching server (prevents stale static files)
- Do NOT hardcode Adventure Engine installation path (must support plugin relocation)
- Do NOT open browser when `--no-browser` flag is specified
- Do NOT proceed with server launch if health check fails after 30 seconds
- Do NOT create character/world files outside documented directory structure (`players/`, `worlds/`)
- Do NOT modify dice roll randomness (must use system RANDOM for fairness)
- Do NOT exceed 2KB content limit for panel pattern examples
- Do NOT provide dice rolling without JSON output (ensures programmatic use)

## Technical Context

### Existing Stack

- **Plugin Framework**: Claude Code plugin system with YAML skill frontmatter
- **Runtime**: Bash scripts for lifecycle management and dice rolling
- **Application**: Bun-based Adventure Engine (frontend: React/Vite, backend: Bun server)
- **Data Format**: Markdown files for character sheets, world state, locations, NPCs, quests
- **Process Management**: PID file-based process tracking with signal handling

### Integration Points

- **Claude Code**: Plugin skills invoked through natural language trigger descriptions
- **Adventure Engine**: Server launched via `bun run start` with PROJECT_DIR environment variable
- **File System**: Reads/writes markdown templates to adventure project directories
- **Browser**: Launches system browser via xdg-open (Linux) or open (macOS)
- **Environment Variables**: Reads configuration from multiple `.env` file locations

### Patterns to Respect

- **Fire-and-forget execution**: Launch script returns control to Claude Code while server runs independently
- **Graceful degradation**: Missing browser command logs warning but doesn't fail launch
- **Environment precedence**: Project-specific .env overrides engine defaults
- **Template-based initialization**: Provide markdown structure templates for game master to populate
- **Absolute paths**: Convert all paths to absolute before passing to SDK or server

## Acceptance Tests

1. **Launch Adventure Server**: Given a valid adventure project directory, when user invokes enter-world skill, then server launches, passes health check within 30 seconds, browser opens to localhost:3000, and PID file is created
2. **Launch Without Browser**: Given `--no-browser` flag, when server launches successfully, then health check passes but no browser window opens
3. **Invalid Project Directory**: Given a non-existent directory path, when launch script executes, then error message indicates directory validation failure and no server process starts
4. **Frontend Build Failure**: Given corrupted frontend source, when launch script executes, then build error is logged and server does not start
5. **Server Health Check Timeout**: Given server that fails to respond, when health check retries for 30 seconds, then launch fails with timeout error and server process is killed
6. **Graceful Shutdown**: Given running server with valid PID file, when stop script executes, then server receives SIGTERM, shuts down within 5 seconds, and PID file is removed
7. **Force Kill**: Given server that ignores SIGTERM, when graceful shutdown times out, then server receives SIGKILL and is terminated
8. **Stale PID Protection**: Given PID file pointing to non-bun process, when stop script executes, then warning is logged, PID file is removed, and no process is killed
9. **Dice Roll Standard**: Given expression "2d6+3", when dice roller executes, then JSON output contains two rolls (1-6 each), modifier 3, and valid total
10. **Dice Roll Fudge**: Given expression "4dF", when dice roller executes, then JSON output contains four rolls (each -1, 0, or +1) and calculated total
11. **Invalid Dice Expression**: Given expression "xyz", when dice roller executes, then JSON error message with usage guidance is returned
12. **Character Initialization**: Given new character "Kael Thouls", when character creation guidance is followed, then skill documents creation of `players/kael-thouls/sheet.md` and `state.md` with proper template structure
13. **World Initialization**: Given new world "Eldoria", when world creation guidance is followed, then skill documents creation of `worlds/eldoria/` with world_state.md, locations.md, characters.md, and quests.md files
14. **Panel Pattern Lookup**: Given combat scenario, when GM consults panel-patterns skill, then combat initiative tracker pattern is provided with position (sidebar), persistence (false), and content structure example
15. **Environment Variable Precedence**: Given REPLICATE_API_TOKEN in both backend/.env and project/.env, when launch script sources files, then project value takes precedence

## Resolved Questions

- [x] **Project structure validation**: No - directory existence check is sufficient
- [x] **Dice roller advantage/disadvantage**: No special notation needed - JSON output always includes individual rolls array, allowing consumers to implement advantage/disadvantage logic
- [x] **Stop script multiple servers**: No - stop script only handles the single server in current project directory
- [x] **Panel pattern MCP integration**: Yes - skill should include MCP tool integration examples for practical use
- [x] **Server already running detection**: Yes, but only via `.adventure-engine.pid` file existence check (not port scanning)

## Out of Scope

- Implementing the Adventure Engine application itself (this plugin only launches it)
- MCP server integration for character/world management (handled by Adventure Engine backend)
- Custom dice roll algorithms or weighted randomness
- Multi-user/multi-player session management
- Real-time WebSocket communication (handled by Adventure Engine, not plugin)
- Character sheet validation or RPG system rule enforcement
- Automated panel creation based on narrative context (requires AI integration in Adventure Engine)
- Version migration for adventure project file formats
- Cross-platform package management (assumes Bun is installed)

---

**Next Phase**: Once approved, use `/spiral-grove:plan-generation` to create technical implementation plan.
