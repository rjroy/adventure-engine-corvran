---
version: 1.0.0
status: Draft
created: 2025-12-20
last_updated: 2025-12-20
authored_by:
  - Module Spec Synthesizer <reverse-engineered>
---

# Frontend Application Specification

**Reverse-Engineered**: true
**Source Module**: frontend

## Executive Summary

The Adventure Engine frontend is a React-based web application that provides a real-time, interactive text-based adventure game interface. It connects to a WebSocket backend to deliver streaming narrative responses, dynamic theming, and contextual information panels. The application emphasizes accessibility, visual feedback, and resilient network handling to create an immersive storytelling experience.

The frontend manages complex state synchronization across WebSocket connections, handles streaming text rendering with sub-second latency, and provides a sophisticated theming system that responds to narrative mood changes. It supports both new adventure creation and resumption of existing sessions via localStorage persistence.

## User Story

As a player, I want to interact with a text-based adventure game through a responsive web interface, so that I can experience immersive storytelling with real-time narrative responses, dynamic visual themes that reflect the story mood, and contextual information panels that enhance my understanding of the game world.

## Stakeholders

- **Primary**: Adventure game players seeking immersive text-based experiences
- **Secondary**: Game masters/content creators designing adventures, frontend developers maintaining the UI, backend developers integrating with the WebSocket protocol
- **Tertiary**: Operations teams monitoring infrastructure, QA teams validating releases, product owners prioritizing features

## Success Criteria

1. WebSocket connection establishes within 2 seconds and automatically reconnects within 30 seconds of disconnection
2. Streaming narrative text appears with <200ms latency per chunk
3. Theme transitions complete within 1.5 seconds with smooth visual effects
4. All UI components meet WCAG 2.1 AA contrast requirements (4.5:1 for text)
5. Application remains responsive during streaming with no input blocking
6. 100% test coverage for critical message flows (authentication, streaming, error handling)

## Functional Requirements

### Adventure Management

- **REQ-F-1**: System must support creating new adventures via POST to `/adventure/new` endpoint
- **REQ-F-2**: System must support resuming existing adventures using stored adventureId and sessionToken
- **REQ-F-3**: System must persist adventure session credentials in localStorage for automatic resume
- **REQ-F-4**: System must fetch and display list of available adventures from `/api/adventures` endpoint
- **REQ-F-5**: System must display adventure metadata including creation date, last active time, current scene, and background image

### WebSocket Communication

- **REQ-F-6**: System must establish WebSocket connection with authentication via token-based handshake
- **REQ-F-7**: System must send authenticate message with session token before sending start_adventure message
- **REQ-F-8**: System must support sending player input messages with text payload
- **REQ-F-9**: System must receive and process streaming GM responses (start, chunk, end message sequence)
- **REQ-F-10**: System must handle heartbeat ping messages every 30 seconds to maintain connection
- **REQ-F-11**: System must support aborting in-progress GM responses via abort message
- **REQ-F-12**: System must support triggering narrative recap/compaction via recap message

### Narrative Display

- **REQ-F-13**: System must display narrative history as chronological entries (player inputs and GM responses)
- **REQ-F-14**: System must render streaming GM responses incrementally as chunks arrive
- **REQ-F-15**: System must display history summary when available (compacted narrative context)
- **REQ-F-16**: System must render markdown in GM responses with sanitization (only p, strong, em, ul, ol, li elements)
- **REQ-F-17**: System must auto-scroll narrative log to bottom on new entries

### Dynamic Theming

- **REQ-F-18**: System must support theme moods: calm, tense, mysterious, ominous, triumphant
- **REQ-F-18a**: Each theme must define: primary color, secondary color, text colors, background colors, font family, background image URL, and accent decorations
- **REQ-F-18b**: Theme definitions must be data-driven (JSON config in themes.json), not hard-coded in component CSS
- **REQ-F-19**: System must apply theme changes received via theme_change server messages
- **REQ-F-20**: System must update CSS custom properties for colors, fonts, and accents
- **REQ-F-20a**: Theme changes must update UI decorations including border styles and shadow effects
- **REQ-F-21**: System must support custom background images via backgroundUrl in theme_change payload
- **REQ-F-21a**: Narrative entry styling (player/GM message appearance) must adapt to current theme
- **REQ-F-22**: System must debounce rapid theme changes within 1 second to prevent visual flicker
- **REQ-F-23**: System must transition between themes smoothly over configurable duration (default 1500ms)
- **REQ-F-24**: System must reset to default "calm" theme on reconnection

### Information Panels

- **REQ-F-25**: System must display server-created info panels via panel_create messages
- **REQ-F-26**: System must update panel content via panel_update messages
- **REQ-F-27**: System must dismiss panels via panel_dismiss messages
- **REQ-F-28**: System must support panel positions: sidebar, header, overlay
- **REQ-F-29**: System must allow minimizing/expanding panels via toggle button
- **REQ-F-30**: System must render panel content as markdown with sanitization
- **REQ-F-31**: System must support dragging overlay panels to custom positions
- **REQ-F-32**: System must maintain panel stacking order by creation timestamp (oldest to newest)

### Error Handling

- **REQ-F-33**: System must display error messages received via error server messages
- **REQ-F-34**: System must distinguish retryable errors (RATE_LIMIT, GM_ERROR, PROCESSING_TIMEOUT) from non-retryable errors (INVALID_TOKEN, ADVENTURE_NOT_FOUND, STATE_CORRUPTED)
- **REQ-F-35**: System must provide retry button for retryable errors that resends last player input
- **REQ-F-36**: System must provide dismiss button for all errors to clear error state
- **REQ-F-37**: System must apply theme mood based on error severity (tense for retryable, ominous for non-retryable)
- **REQ-F-38**: System must restore previous theme mood when error is cleared or streaming resumes
- **REQ-F-39**: System must clear streaming state when error occurs during GM response

### Connection Management

- **REQ-F-40**: System must display connection status indicator (connected, disconnected, reconnecting)
- **REQ-F-41**: System must attempt automatic reconnection with exponential backoff (1s → 30s max delay)
- **REQ-F-42**: System must give up reconnection after 30 seconds total elapsed time
- **REQ-F-43**: System must disable input during disconnected and reconnecting states
- **REQ-F-44**: System must disable input while GM is responding to prevent concurrent requests

### User Input

- **REQ-F-45**: System must provide text input field for player commands
- **REQ-F-46**: System must submit player input on Enter key press
- **REQ-F-47**: System must clear input field after successful submission
- **REQ-F-48**: System must display abort button during GM response streaming
- **REQ-F-49**: System must track last player input for retry functionality
- **REQ-F-50**: System must show context-appropriate placeholder text (reconnecting, waiting for response, ready for input)

### Tool Status and Recap

- **REQ-F-51**: System must display tool status bar showing GM tool usage state (active/idle) and description
- **REQ-F-52**: System must provide recap button to trigger narrative compaction
- **REQ-F-53**: System must show confirmation dialog before executing recap
- **REQ-F-54**: System must disable recap button during GM response or disconnected state
- **REQ-F-55**: System must display recap in-progress indicator when recap_started message received
- **REQ-F-56**: System must update narrative history and summary when recap_complete message received

## Non-Functional Requirements

### Performance

- **REQ-NF-1** (Latency): Streaming narrative chunks must render within 200ms of WebSocket message receipt
- **REQ-NF-2** (Responsiveness): UI must remain interactive during streaming (no blocking operations)
- **REQ-NF-3** (Startup): Application must render initial UI within 1 second of page load
- **REQ-NF-4** (Theme Transition): Theme changes must complete within 1.5 seconds (configurable)
- **REQ-NF-5** (Reconnection): WebSocket must attempt reconnection within 1 second of disconnection

### Usability

- **REQ-NF-6** (Accessibility): All text must meet WCAG 2.1 AA contrast ratio (4.5:1 minimum)
- **REQ-NF-7** (Visual Feedback): Connection status must be clearly visible at all times
- **REQ-NF-8** (Error Clarity): Error messages must display both user-friendly message and technical details (expandable)
- **REQ-NF-9** (Input State): Input field must clearly indicate when disabled (visual + placeholder text)
- **REQ-NF-10** (Streaming Indicator): Streaming responses must be visually distinguishable from completed responses

### Security

- **REQ-NF-11** (XSS Prevention): Markdown rendering must sanitize content (allowlist: p, strong, em, ul, ol, li only)
- **REQ-NF-12** (Token Handling): Session tokens must be sent via WebSocket messages, not URL parameters
- **REQ-NF-13** (localStorage Isolation): Session credentials must be scoped to adventure-specific keys
- **REQ-NF-14** (Protocol Validation): All incoming WebSocket messages must be validated against Zod schema before processing

### Reliability

- **REQ-NF-15** (Reconnection): System must automatically reconnect on connection loss without user intervention
- **REQ-NF-16** (State Consistency): Narrative history must be restored from server on reconnection (via adventure_loaded message)
- **REQ-NF-17** (Message Ordering): Streaming chunks must be ignored if messageId mismatches current streaming session
- **REQ-NF-18** (Duplicate Protection): Duplicate gm_response_end messages must not create duplicate narrative entries
- **REQ-NF-19** (Error Recovery): Errors during streaming must clear streaming state and restore input availability

### Maintainability

- **REQ-NF-20** (Type Safety): All protocol messages must have TypeScript type definitions
- **REQ-NF-21** (Testing): Critical flows (authentication, streaming, error handling) must have integration test coverage
- **REQ-NF-22** (Component Isolation): UI components must be isolated via React Context (ThemeContext, PanelContext)
- **REQ-NF-23** (Code Style): Code must pass ESLint and Prettier checks before build

### Consistency

- **REQ-NF-24** (Theme Coherence): All UI elements must respect CSS custom properties from active theme
- **REQ-NF-25** (Protocol Alignment): Frontend message types must match shared protocol definitions
- **REQ-NF-26** (Visual Language): All panels, buttons, and inputs must follow consistent design patterns

### Compatibility

- **REQ-NF-27** (Browser Support): System must support modern browsers (latest stable versions of Chrome, Firefox, Safari, and Edge)

## Explicit Constraints (DO NOT)

- Do NOT send session tokens in WebSocket URL query parameters (use authenticate message instead)
- Do NOT render arbitrary HTML in markdown content (allowlist only: p, strong, em, ul, ol, li)
- Do NOT block the main thread during streaming (use React state updates for incremental rendering)
- Do NOT persist panel minimize state server-side (local browser session only)
- Do NOT allow drag-to-move for sidebar or header panels (overlay panels only)
- Do NOT retry non-retryable errors automatically (require user interaction)
- Do NOT exceed 30 seconds total reconnection time (give up after max time)
- Do NOT submit player input during disconnected/reconnecting states
- Do NOT submit concurrent player inputs (disable input while GM responding)

## Technical Context

### Existing Stack

- **Frontend Framework**: React 19.0.0 with TypeScript 5.7.0
- **Build Tool**: Vite 6.0.0
- **Testing**: Vitest 4.0.15, Testing Library, jsdom
- **Markdown Rendering**: react-markdown 10.1.0 with remark-gfm 4.0.1
- **Validation**: Zod 3.24.1 (shared protocol schemas)
- **Runtime**: Bun (development and testing)

### Integration Points

- **WebSocket Backend**: Connects to `/ws?adventureId={id}` endpoint with wss:// or ws:// protocol
- **REST API**: POST `/adventure/new` for adventure creation, GET `/api/adventures` for adventure list
- **Shared Protocol**: Imports protocol types from `../../../shared/protocol` (TypeScript definitions, Zod schemas)
- **Static Assets**: Background images from `/backgrounds/` directory
- **Theme Configuration**: JSON-based theme definitions in `themes.json`

### Patterns to Respect

- **Context-Based State**: Use React Context for cross-component state (ThemeContext, PanelContext)
- **Custom Hooks**: Encapsulate WebSocket logic in `useWebSocket` hook
- **Memoization**: Use React.memo for performance-critical components (InfoPanel, PanelZones)
- **Type Safety**: All server messages validated with Zod before processing
- **CSS Custom Properties**: All theming via CSS variables (no inline styles for colors)
- **Component Naming**: PascalCase for components, camelCase for hooks and utilities
- **Test Organization**: Unit tests in `tests/unit/`, integration tests in `tests/integration/`

## Acceptance Tests

1. **New Adventure Creation**: User clicks "New Adventure", receives adventureId and sessionToken, WebSocket authenticates, adventure_loaded message populates initial history
2. **Resume Existing Adventure**: User clicks "Resume Adventure" with localStorage credentials, WebSocket authenticates, adventure_loaded restores narrative history and summary
3. **Player Input → GM Response Streaming**: User types command and presses Enter, player input appears immediately, gm_response_start triggers "Waiting for response..." placeholder, gm_response_chunks accumulate into streaming display, gm_response_end finalizes entry and re-enables input
4. **Theme Change on Server Event**: Server sends theme_change with mood "ominous", CSS variables update within 1500ms, background image changes if backgroundUrl provided, theme persists until next change
5. **Info Panel Creation**: Server sends panel_create with title and content, panel appears in specified position (sidebar/header/overlay), minimize button toggles visibility, overlay panels can be dragged, panel_update changes content, panel_dismiss removes panel
6. **Error Handling with Retry**: Server sends error with retryable=true, error panel displays with retry button, user clicks retry, last player input resends, error clears on gm_response_start
7. **Connection Loss and Reconnection**: WebSocket disconnects (close code 1006), status becomes "reconnecting", exponential backoff attempts reconnection, reconnection succeeds within 30s, adventure_loaded restores state
8. **Abort Streaming Response**: GM response starts streaming, user clicks abort button, abort message sent, gm_response_end received, input re-enabled
9. **Recap with Confirmation**: User clicks recap button, confirmation dialog appears, user confirms, recap message sent, recap_started shows indicator, recap_complete updates history and summary with compacted versions
10. **Markdown Rendering with Sanitization**: GM response includes markdown with bold, italic, lists, narrative entry renders formatted text, disallowed elements (script, img, a) are stripped

## Open Questions

- None identified in current implementation

## Out of Scope

- Server-side rendering (SSR) or static site generation (SSG)
- Offline functionality (requires active WebSocket connection)
- Multi-language internationalization (UI text is English-only)
- Mobile-specific touch gestures (uses mouse events for drag)
- Audio/video playback for narrative enhancements
- Chat/multiplayer features (single-player only)
- Save/export narrative history to file (localStorage only)
- Custom theme creation by users (themes are predefined in themes.json)
- Accessibility features beyond WCAG AA (e.g., screen reader optimizations for streaming text)

---

**Next Phase**: This specification was reverse-engineered from implementation. Use `/spiral-grove:validate-completeness` to verify all requirements are implemented.
