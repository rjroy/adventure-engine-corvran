# Adventure Engine Corvran â€“ AI Contributor Guide

- Big picture: Bun/Hono backend drives a Claude Agent GM over WebSocket; React/Vite frontend renders streaming narrative, dynamic themes, and panels; shared protocol types live in [shared/protocol.ts](shared/protocol.ts).
- State & persistence: Adventure save dirs live under `backend/adventures/{id}` with `state.json` + `history.json` managed by [backend/src/adventure-state.ts](backend/src/adventure-state.ts); non-persistent panels are filtered out on save; compaction archives history and generates summaries via [backend/src/services/history-compactor.ts](backend/src/services/history-compactor.ts).
- World data sandbox: Gameplay file I/O happens inside `PROJECT_DIR` (must exist) for player/world markdown; managers in [backend/src/player-manager.ts](backend/src/player-manager.ts) and [backend/src/world-manager.ts](backend/src/world-manager.ts) auto-create missing refs when loading a session.
- Agent prompt & tools: GM prompt builder + MCP tools live in [backend/src/gm-prompt.ts](backend/src/gm-prompt.ts); tools include `set_theme`, XP style, character/world select/create, and panel create/update/dismiss/list. GameSession wires callbacks and maps SDK tool names to player-friendly status text in [backend/src/game-session.ts](backend/src/game-session.ts).
- Runtime flow: Hono server and WebSocket upgrade are in [backend/src/server.ts](backend/src/server.ts); connection limits, Origin allowlist, and token auth are enforced before GameSession initialization. Each session queues inputs to avoid race conditions, streams responses, supports abort, recap, and session recovery (history-backed) in [backend/src/game-session.ts](backend/src/game-session.ts).
- Theming & imagery: Theme change requests go through the MCP tool; BackgroundImageService coordinates catalog-first lookup then generation via Replicate (optional) with fallbacks in [backend/src/services/background-image.ts](backend/src/services/background-image.ts). Theme/panel state is applied client-side by ThemeContext and PanelContext.
- Frontend protocol handling: WebSocket hook [frontend/src/hooks/useWebSocket.ts](frontend/src/hooks/useWebSocket.ts) handles authenticate + start_adventure handshake, heartbeat, exponential backoff reconnect, theme_change, and panel_* messages. [frontend/src/App.tsx](frontend/src/App.tsx) keeps local narrative history, merges streaming chunks, surfaces tool status, recap confirmations, and error theming.
- Input and path safety: Player input is sanitized and blocked on role manipulation/length in [backend/src/validation.ts](backend/src/validation.ts); adventure IDs/slugs use strict validation + safeResolvePath to stop traversal.
- Environment expectations: Call `validateEnv()` before startup (see [backend/src/index.ts](backend/src/index.ts)). Critical vars: PORT/HOST, ADVENTURES_DIR (default backend/adventures), STATIC_ROOT (frontend/dist), PROJECT_DIR (required), ALLOWED_ORIGINS, MAX_CONNECTIONS, INPUT_TIMEOUT, MOCK_SDK, REPLICATE_API_TOKEN, compaction thresholds. Zod must stay 3.24.x for SDK compatibility.
- Background services: Image catalog + generator are initialized at server boot; generator failures degrade gracefully to catalog/fallback.
- Testing/development commands (run from subdir): Backend `bun run dev|test|test:unit|test:integration|typecheck|lint`; Frontend `bun run dev|test|test:watch|typecheck|lint`; build flow `frontend: bun run build` then `backend: bun run start`. Set `MOCK_SDK=true` to run backend tests without Agent SDK.
- WebSocket protocol highlights: Client sends authenticate then start_adventure; server emits adventure_loaded with history/summary, gm_response_{start,chunk,end}, theme_change, panel_{create,update,dismiss}, tool_status, recap_{started,complete,error}, error payloads. Client can send player_input, abort, ping, recap.
- Error handling: SDK errors are mapped to user-facing codes in [backend/src/error-handler.ts](backend/src/error-handler.ts); timeouts trigger PROCESSING_TIMEOUT with retryable guidance; recovery uses history context when session invalidates.
- Logging: Pino-based logger with request-scoped child loggers; LOG_LEVEL defaults to info, LOG_FILE toggles rolling logs.
- Conventions: TypeScript strict, ESLint + Prettier (double quotes, semicolons, trailing commas), unused vars prefixed with `_`. Avoid upgrading Zod, keep MCP tool names consistent with protocol. Use catalog-first theme background flow and never bypass sanitization/validation paths.
- Frontend UX expectations: Maintain mood-driven theming and panels; restore theme after errors; keep adventure_id/sessionToken private (sent via authenticate message, not URL); keep heartbeat/reconnect behavior intact.
- Data/location limits: Panels capped at five (see PanelManager), content max 2KB; MAX_INPUT_LENGTH is 2000; compaction thresholds configurable via env but defaults assume ~100k chars.
- External integrations: Claude Agent SDK powers GM + MCP tools; Replicate optional for image generation; Vite dev server proxies to backend.

If anything here is unclear or seems incomplete, please tell me which sections need more detail so I can refine them.
